# 設計書

## 🗄️ データベース設計

### ユーザー管理テーブル
**テーブル名：** users  
**目的：** 匿名ユーザーの管理

| 項目名 | 物理名 | データ型 | 桁数 | 説明 | 制約 |
|--------|---------|----------|------|------|------|
| ID | id | UUID | - | 主キー | NOT NULL, PRIMARY KEY |
| 端末識別ID | device_id | VARCHAR | 255 | 端末識別用ID | NOT NULL, UNIQUE |
| ユーザー名 | user_name | VARCHAR | 10 | 表示用ユーザー名 | NULL |
| プロフィール画像 | profile_image | VARCHAR | 500 | プロフィール画像URL | NULL |
| 登録者 | created_by | UUID | - | 登録者ID | NULL |
| 登録日時 | created_at | TIMESTAMP | - | 登録日時 | DEFAULT NOW() |
| 更新者 | updated_by | UUID | - | 更新者ID | NULL |
| 更新日時 | updated_at | TIMESTAMP | - | 更新日時 | DEFAULT NOW() |

### 季節キーワードテーブル
**テーブル名：** season_keywords  
**目的：** 季節ごとのキーワード管理

| 項目名 | 物理名 | データ型 | 桁数 | 説明 | 制約 |
|--------|---------|----------|------|------|------|
| ID | id | UUID | - | 主キー | NOT NULL, PRIMARY KEY |
| キーワード名 | keyword_name | VARCHAR | 20 | 季節キーワード（例：桜、花火） | NOT NULL |
| 季節区分 | season_type | VARCHAR | 1 | 1:春、2:夏、3:秋、4:冬 | CHECK(season_type IN ('1','2','3','4')) |
| 月 | month | INTEGER | - | 該当月（1-12） | CHECK(month BETWEEN 1 AND 12) |
| 表示順序 | display_order | INTEGER | - | 画面での表示順 | DEFAULT 0 |
| 登録者 | created_by | UUID | - | 登録者ID | NULL |
| 登録日時 | created_at | TIMESTAMP | - | 登録日時 | DEFAULT NOW() |
| 更新者 | updated_by | UUID | - | 更新者ID | NULL |
| 更新日時 | updated_at | TIMESTAMP | - | 更新日時 | DEFAULT NOW() |

**初期データ：**
- 春（3-5月）：桜、花見、いちご狩り、菜の花、ピクニック
- 夏（6-8月）：花火、海、プール、かき氷、夏祭り
- 秋（9-11月）：紅葉、月見、ハロウィン、栗拾い、コスモス
- 冬（12-2月）：クリスマス、雪、イルミネーション、温泉、梅

### お出かけ記録テーブル
**テーブル名：** records  
**目的：** ユーザーのお出かけ記録管理

| 項目名 | 物理名 | データ型 | 桁数 | 説明 | 制約 |
|--------|---------|----------|------|------|------|
| ID | id | UUID | - | 主キー | NOT NULL, PRIMARY KEY |
| ユーザーID | user_id | UUID | - | ユーザーテーブル外部キー | NOT NULL, FOREIGN KEY |
| 日付 | date | DATE | - | お出かけ日付 | NOT NULL |
| 写真URL | photo_url | VARCHAR | 500 | 写真ファイルのURL | NULL |
| コメント | comment | TEXT | - | 感想・メモ | NOT NULL |
| 歩数 | steps | INTEGER | - | 歩数（Phase 1は手動入力） | CHECK(steps >= 0 AND steps <= 99999) |
| 移動時間（分） | travel_time_minutes | INTEGER | - | 移動にかかった時間 | CHECK(travel_time_minutes >= 0 AND travel_time_minutes <= 9999) |
| 移動手段 | transport_method | VARCHAR | 1 | 1:徒歩、2:自転車、3:公共交通機関、4:車 | CHECK(transport_method IN ('1','2','3','4')) |
| 季節キーワード | season_keyword | VARCHAR | 20 | 選択したキーワード | NOT NULL |
| スポット名 | spot_name | VARCHAR | 50 | 訪問したスポット名 | NOT NULL |
| 登録者 | created_by | UUID | - | 登録者ID | NULL |
| 登録日時 | created_at | TIMESTAMP | - | 登録日時 | DEFAULT NOW() |
| 更新者 | updated_by | UUID | - | 更新者ID | NULL |
| 更新日時 | updated_at | TIMESTAMP | - | 更新日時 | DEFAULT NOW() |

### Wishリストテーブル（Phase 2）
**テーブル名：** wishlist  
**目的：** 行きたいスポットの管理

| 項目名 | 物理名 | データ型 | 桁数 | 説明 | 制約 |
|--------|---------|----------|------|------|------|
| ID | id | UUID | - | 主キー | NOT NULL, PRIMARY KEY |
| ユーザーID | user_id | UUID | - | ユーザーテーブル外部キー | NOT NULL, FOREIGN KEY |
| スポット名 | spot_name | VARCHAR | 50 | 行きたいスポット名 | NOT NULL |
| 移動時間 | travel_time | VARCHAR | 50 | 移動時間（例：徒歩15分） | NULL |
| 説明 | description | TEXT | - | スポットの説明文 | NULL |
| 季節キーワード | season_keyword | VARCHAR | 20 | 関連する季節キーワード | NULL |
| 完了フラグ | is_completed | BOOLEAN | - | 訪問済みかどうか | DEFAULT FALSE |
| 登録者 | created_by | UUID | - | 登録者ID | NULL |
| 登録日時 | created_at | TIMESTAMP | - | 登録日時 | DEFAULT NOW() |
| 更新者 | updated_by | UUID | - | 更新者ID | NULL |
| 更新日時 | updated_at | TIMESTAMP | - | 更新日時 | DEFAULT NOW() |

---

## 🔌 API設計

### 認証関連API
**目的：** 匿名ユーザーの作成・管理

#### 匿名ユーザー作成
- **エンドポイント：** POST /api/auth/anonymous
- **機能：** 新規匿名ユーザーを作成
- **入力：** なし
- **出力：** ユーザーID、端末識別ID

#### ユーザー情報取得
- **エンドポイント：** POST /api/auth/user
- **機能：** 既存ユーザー情報を取得
- **入力：** 端末識別ID（リクエストボディ）
- **出力：** ユーザー情報（ID、端末識別ID、ユーザー名、プロフィール画像URL、作成日時）

#### ユーザー情報更新
- **エンドポイント：** PUT /api/auth/user
- **機能：** ユーザー名とプロフィール画像を更新
- **入力：** 端末識別ID、ユーザー名、プロフィール画像（リクエストボディ）
- **出力：** 更新されたユーザー情報

### 季節キーワードAPI
**目的：** 季節キーワードの取得

#### 全キーワード取得
- **エンドポイント：** GET /api/keywords
- **機能：** 全ての季節キーワードを取得
- **入力：** なし
- **出力：** キーワード一覧（季節・表示順でソート）

### AIレコメンドAPI
**目的：** おすすめスポットの提案

#### スポット推薦
- **エンドポイント：** POST /api/recommendations
- **機能：** 選択したキーワードに基づくスポット推薦
- **入力：** 季節キーワード、現在地情報
- **出力：** おすすめスポット一覧（3-5件）

**出力項目：**
- スポット名
- 距離（例：1.2km）
- 移動時間（例：徒歩15分）
- 説明文（50文字以内）
- 季節の見どころ（30文字以内）

### 記録管理API
**目的：** お出かけ記録の管理

#### 記録作成
- **エンドポイント：** POST /api/records
- **機能：** 新しいお出かけ記録を作成
- **入力：** 記録データ（日付、写真、コメント等）
- **出力：** 作成された記録情報

#### 月別記録取得
- **エンドポイント：** GET /api/records
- **機能：** 指定月の記録一覧を取得
- **入力：** 年、月、ユーザーID（クエリパラメータ）
- **出力：** 該当月の記録一覧

#### 記録詳細取得
- **エンドポイント：** GET /api/records/{記録ID}
- **機能：** 特定の記録の詳細を取得
- **入力：** 記録ID（URLパラメータ）
- **出力：** 記録詳細情報

### WishリストAPI（Phase 2）
**目的：** Wishリストの管理

#### Wishリスト取得
- **エンドポイント：** GET /api/wishlist
- **機能：** ユーザーのWishリスト一覧を取得
- **入力：** ユーザーID（クエリパラメータ）
- **出力：** Wishリストアイテム一覧

#### Wishリスト追加
- **エンドポイント：** POST /api/wishlist
- **機能：** 新しいスポットをWishリストに追加
- **入力：** スポット情報（名前、説明等）
- **出力：** 追加されたアイテム情報

#### Wishリスト更新
- **エンドポイント：** PUT /api/wishlist/{アイテムID}
- **機能：** Wishリストアイテムの状態更新（完了/未完了）
- **入力：** 完了フラグ
- **出力：** 更新結果

#### Wishリスト削除
- **エンドポイント：** DELETE /api/wishlist/{アイテムID}
- **機能：** Wishリストからアイテムを削除
- **入力：** アイテムID（URLパラメータ）
- **出力：** 削除結果

---

## 🤖 AIプロンプト設計

### 目的
季節キーワードに基づいて、ユーザーの現在地周辺のおすすめスポットを提案する

### 入力情報
- **季節キーワード：** ユーザーが選択したキーワード（例：桜、花火）
- **現在地情報：** GPS取得または手動入力された位置情報
- **移動時間制限：** 30分以内（固定）
- **移動手段：** 主に徒歩を想定

### プロンプト構成要素

#### 1. AIの役割設定
- 親しみやすく丁寧なトーンで話すスポット案内アシスタント
- 全国各地域の魅力を熟知している設定
- ユーザーフレンドリーで温かみのある口調

#### 2. 出力要件
- **スポット数：** 3-4個
- **実在性：** 実在するスポットのみ提案
- **アクセス性：** 移動時間30分以内
- **季節性：** 選択したキーワードに関連する要素を含む

#### 3. 出力フォーマット
各スポットについて以下の情報を含む：
- **スポット名：** 正式名称
- **距離：** 現在地からの距離（km単位）
- **移動時間：** 徒歩での所要時間
- **説明文：** 親しみやすく丁寧な口調での紹介（50文字以内）
- **季節ポイント：** そのスポットで楽しめる季節の要素（30文字以内）

### 期待する出力例

#### 入力：キーワード「桜」、現在地「東京駅周辺」
**期待する出力：**

**スポット1：皇居東御苑**
- 距離：1.2km
- 移動時間：徒歩15分
- 説明：無料で楽しめる桜の名所です。江戸城跡の歴史も感じられます
- 季節ポイント：ソメイヨシノが美しく咲き誇る

**スポット2：千鳥ヶ淵緑道**
- 距離：1.8km
- 移動時間：徒歩20分
- 説明：桜のトンネルが続く都内屈指の桜スポットです
- 季節ポイント：夜桜ライトアップも見事

**スポット3：日比谷公園**
- 距離：0.9km
- 移動時間：徒歩12分
- 説明：オフィス街のオアシス。お弁当を持ってピクニックも楽しめます
- 季節ポイント：桜とチューリップの共演

### エラー処理
- API制限やネットワークエラー時のフォールバック応答
- 「おすすめスポット取得中...」等のメッセージ表示
- 再試行を促すユーザーガイダンス

---

## 🎨 画面設計

### 全体デザインコンセプト
- **シンプル系デザイン**
- **季節感のある色使い**
- **スマートフォン最適化**
- **直感的な操作性**

### カラーテーマ設計

#### 季節ごとの基本カラー
- **春（3-5月）：** 桜色系（#FFB7C5）
- **夏（6-8月）：** スカイブルー系（#87CEEB）
- **秋（9-11月）：** ベージュ系（#DEB887）
- **冬（12-2月）：** ライトスチールブルー系（#B0C4DE）

#### 背景色
- **春：** 薄桜色（#FFF8F0）
- **夏：** アリスブルー（#F0F8FF）
- **秋：** コーンシルク（#FFF8DC）
- **冬：** ゴーストホワイト（#F8F8FF）

### ナビゲーション設計

#### ボトムナビゲーション
- **位置：** 画面下部固定
- **構成：** 3つのタブ
  1. カレンダー（ホーム）
  2. 季節キーワード
  3. Wishリスト
- **アクティブ状態：** 季節カラーで強調
- **アイコン：** 絵文字使用（📅🌸❤️）

### 各画面のレイアウト設計

#### 0. ユーザー情報設定画面（初回のみ）
- **ヘッダー：** 「プロフィール設定」+ スキップボタン
- **メイン：**
  - プロフィール画像選択エリア（デフォルト画像表示）
  - カメラロールボタン
  - ユーザー名入力フィールド（プレースホルダー：「ニックネーム（任意）」）
- **フッター：** 「設定完了」ボタン（季節カラー）
- **背景：** 現在の季節に応じた背景色

#### 1. カレンダー画面（トップ）
- **ヘッダー：** 現在の月表示 + 季節アイコン + プロフィール画像（右上、小サイズ）
- **メイン：** 7×6のカレンダーグリッド
- **記録表示：** 記録のある日付に小さな丸マーク
- **季節背景：** 月に応じた背景色変更
- **タップ動作：** 記録のある日付タップで詳細表示

#### 2. 季節キーワード画面
- **ヘッダー：** 「季節のお出かけ」
- **セクション分け：** 季節ごとにグループ化
- **キーワードボタン：** 丸角の季節カラーボタン
- **レイアウト：** 2列または3列のグリッド配置
- **現在季節：** 最上部に配置

#### 3. スポット選択画面
- **ヘッダー：** 戻るボタン + 選択したキーワード表示
- **AIレコメンド：** カード形式で縦並び
- **各カード内容：**
  - スポット名（大きめフォント）
  - 距離・時間情報（アイコン付き）
  - 説明文
  - 季節ポイント（季節カラーで強調）
  - アクションボタン（Wishリスト追加、地図、記録）
- **代替オプション：** Google検索・Mapsボタン

#### 4. 記録登録画面
- **ヘッダー：** 「記録を残そう」
- **写真選択：** デフォルト画像選択 + カメラロール
- **入力項目：**
  - コメント入力（大きめテキストエリア）
  - 歩数入力（数値）
  - 移動時間入力（数値）
  - 移動手段選択（ラジオボタン）
- **保存ボタン：** 季節カラーの大きめボタン

#### 5. Wishリスト画面（Phase 2）
- **ヘッダー：** 「行きたいスポット」
- **リスト表示：** カード形式
- **カード内容：**
  - スポット名
  - 距離・時間情報
  - 関連キーワード
  - 完了マーク（訪問済み）
  - 削除ボタン
- **空状態：** 季節の絵文字 + 誘導メッセージ

### レスポンシブ対応
- **主要対象：** スマートフォン（375px〜414px）
- **タブレット対応：** 768px以上でレイアウト調整
- **タッチ操作：** 最小タップエリア44px以上
- **フォントサイズ：** 最小14px以上

### アニメーション・インタラクション
- **ページ遷移：** スライドアニメーション
- **ボタン押下：** 軽いスケールエフェクト
- **季節変更：** 背景色のスムーズな変化
- **ローディング：** 季節カラーのスピナー

---

## 🔧 技術設計

### フロントエンド構成
- **フレームワーク：** Next.js 14（App Router）
- **言語：** TypeScript
- **スタイリング：** Tailwind CSS + CSS変数
- **状態管理：** React Context API
- **アイコン：** Lucide React + 絵文字

### バックエンド構成
- **データベース：** Supabase（PostgreSQL）
- **認証：** Supabase匿名認証
- **ファイル保存：** Supabase Storage
- **API：** Next.js API Routes

### 外部サービス連携
- **AI：** Google Gemini 2.0 Flash（無料版）
- **地図：** Google Maps（Phase 2）
- **検索：** Google Search（リンク遷移）

### セキュリティ設計
- **APIキー保護：** サーバーサイドで管理
- **匿名認証：** 個人情報収集なし
- **HTTPS：** 全通信の暗号化
- **入力検証：** SQLインジェクション対策

### パフォーマンス設計
- **画像最適化：** Next.js Image最適化
- **コード分割：** 動的インポート活用
- **キャッシュ戦略：** Static Generation活用
- **API制限対応：** レート制限とエラーハンドリング
